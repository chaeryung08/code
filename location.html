
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>위치 기능 데모</title>
  <link rel="stylesheet" href="style-location.css" />
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha384-some-integrity"
    crossorigin=""
  />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", sans-serif; margin: 12px; }
    h1 { margin: 0 0 8px 0; font-size: 20px; }
    #controls { margin-bottom: 8px; display:flex; gap:8px; flex-wrap:wrap; }
    button { padding:8px 12px; border-radius:8px; border:1px solid #ccc; background:#f7f7f7; cursor:pointer; }
    button:active{ transform:translateY(1px); }
    #info { margin-bottom:8px; white-space:pre-wrap; background:#fafafa; padding:8px; border-radius:8px; border:1px solid #eee; }
    #map { height: 60vh; min-height:300px; border-radius:8px; border:1px solid #ddd; }
    .small { font-size:13px; color:#666; }
  </style>
</head>
<body>
  <h1>📍 현재 위치 가져오기</h1>
  <div id="controls">
    <button id="getPosBtn">현재 위치 가져오기</button>
    <button id="watchBtn">실시간 추적 시작</button>
    <button id="stopWatchBtn" disabled>추적 중지</button>
    <button id="copyBtn">좌표 복사</button>
  </div>

  <div id="info" class="small">위치 정보가 여기에 표시됩니다.</div>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha384-some-integrity"
    crossorigin=""></script>

  <script>
    // 기본 변수
    let map = null;
    let marker = null;
    let watchId = null;
    const infoEl = document.getElementById('info');
    const getPosBtn = document.getElementById('getPosBtn');
    const watchBtn = document.getElementById('watchBtn');
    const stopWatchBtn = document.getElementById('stopWatchBtn');
    const copyBtn = document.getElementById('copyBtn');

    // 지도 초기화 (초기 중심: 세계 중심)
    function initMap() {
      map = L.map('map', { zoomControl: true }).setView([20, 0], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);
    }

    // 위치 정보 표시
    function showPosition(pos) {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const acc = pos.coords.accuracy;
      const alt = pos.coords.altitude;
      const heading = pos.coords.heading;
      const speed = pos.coords.speed;
      const time = new Date(pos.timestamp).toLocaleString();

      infoEl.textContent =
        `위도: ${lat}\n경도: ${lon}\n정확도(미터): ${acc}\n고도: ${alt === null ? '알 수 없음' : alt}\n방향(heading): ${heading === null ? 'N/A' : heading}\n속도(m/s): ${speed === null ? 'N/A' : speed}\n측정시각: ${time}`;

      // 지도에 표시
      if (!map) initMap();
      map.setView([lat, lon], 16);
      if (marker) marker.setLatLng([lat, lon]);
      else marker = L.marker([lat, lon]).addTo(map).bindPopup('현재 위치').openPopup();

      // 정확도 원 표시
      if (pos.coords.accuracy) {
        // accuracy circle: remove previous if exists
        if (window._accuracyCircle) map.removeLayer(window._accuracyCircle);
        window._accuracyCircle = L.circle([lat, lon], { radius: pos.coords.accuracy }).addTo(map);
      }
    }

    // 에러 처리
    function handleError(err) {
      switch (err.code) {
        case err.PERMISSION_DENIED:
          infoEl.textContent = '오류: 위치 권한이 거부되었어. 페이지 권한 설정을 확인해.';
          break;
        case err.POSITION_UNAVAILABLE:
          infoEl.textContent = '오류: 위치 정보를 얻을 수 없어.';
          break;
        case err.TIMEOUT:
          infoEl.textContent = '오류: 요청이 시간초과 되었어.';
          break;
        default:
          infoEl.textContent = '알 수 없는 오류가 발생했어: ' + err.message;
      }
    }

    // 단발성 위치 요청
    function requestPosition() {
      if (!navigator.geolocation) {
        infoEl.textContent = '이 브라우저는 Geolocation을 지원하지 않아.';
        return;
      }
      infoEl.textContent = '위치 요청 중...';
      navigator.geolocation.getCurrentPosition(showPosition, handleError, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 10000
      });
    }

    // 실시간 감시 시작
    function startWatch() {
      if (!navigator.geolocation) {
        infoEl.textContent = '이 브라우저는 Geolocation을 지원하지 않아.';
        return;
      }
      if (watchId !== null) return;
      watchId = navigator.geolocation.watchPosition(pos => {
        showPosition(pos);
        stopWatchBtn.disabled = false;
        watchBtn.disabled = true;
      }, handleError, {
        enableHighAccuracy: true,
        maximumAge: 2000,
        timeout: 10000
      });
      infoEl.textContent = '실시간 추적을 시작했어. 권한을 확인해.';
    }

    // 감시 중지
    function stopWatch() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        watchBtn.disabled = false;
        stopWatchBtn.disabled = true;
        infoEl.textContent += '\n추적을 중지했어.';
      }
    }

    // 좌표 복사
    async function copyCoords() {
      if (!marker) {
        alert('먼저 위치를 가져와야 좌표를 복사할 수 있어.');
        return;
      }
      const { lat, lng } = marker.getLatLng();
      const text = `${lat}, ${lng}`;
      try {
        await navigator.clipboard.writeText(text);
        alert('좌표 복사됨: ' + text);
      } catch (e) {
        alert('복사 실패: ' + e);
      }
    }

    // 이벤트 바인딩
    getPosBtn.addEventListener('click', requestPosition);
    watchBtn.addEventListener('click', startWatch);
    stopWatchBtn.addEventListener('click', stopWatch);
    copyBtn.addEventListener('click', copyCoords);

    // 첫 로드에 지도 초기화 (옵션)
    initMap();

    // 페이지가 보안 컨텍스트인지 경고 (선택적)
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      const warn = '\n주의: 위치 기능은 HTTPS(또는 localhost)에서만 제대로 동작해. file://로 열면 안 될 가능성이 높아.';
      infoEl.textContent = warn + '\n' + infoEl.textContent;
    }
  </script>
</body>
</html>
